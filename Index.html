<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabdullahi Ibnu Mubaarak School</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><path d=%22M50 5 L85 20 V50 C85 75 50 95 50 95 C50 95 15 75 15 50 V20 L50 5 Z%22 fill=%22%2310b981%22 stroke=%22%23ffffff%22 stroke-width=%222%22/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {  
            --primary: #0f172a;  
            --success: #10b981;  
            --danger: #ef4444;  
            --warning: #f59e0b;  
        }  
    
        body {  
            font-family: 'Inter', sans-serif;  
            background-color: #f3f4f6;  
            color: #1e293b;  
        }  
    
        h1, h2, h3, h4, h5, h6 {  
            font-family: 'Outfit', sans-serif;  
        }  
    
        /* Glassy Effect Classes */  
        .glass-card {  
            background: rgba(255, 255, 255, 0.9);  
            backdrop-filter: blur(10px);  
            -webkit-backdrop-filter: blur(10px);  
            border: 1px solid rgba(255, 255, 255, 0.5);  
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);  
            border-radius: 1rem;  
        }  
    
        .glass-sidebar {  
            background: var(--primary);  
            color: white;  
        }  
    
        /* Animations */  
        .fade-in {  
            animation: fadeIn 0.4s ease-out forwards;  
        }  
    
        @keyframes fadeIn {  
            from { opacity: 0; transform: translateY(10px); }  
            to { opacity: 1; transform: translateY(0); }  
        }  
    
        /* Custom Scrollbar */  
        ::-webkit-scrollbar {  
            width: 8px;  
        }  
        ::-webkit-scrollbar-track {  
            background: transparent;  
        }  
        ::-webkit-scrollbar-thumb {  
            background: #cbd5e1;  
            border-radius: 4px;  
        }  
        ::-webkit-scrollbar-thumb:hover {  
            background: #94a3b8;  
        }  
    
        /* Nav Active State */  
        .nav-link.active {  
            background: rgba(255, 255, 255, 0.1);  
            border-left: 4px solid var(--success);  
        }  
    </style>
    
</head>
<body class="h-screen w-screen overflow-hidden">
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100 bg-[url('https://images.unsplash.com/photo-1503676260728-1c00da094a0b?q=80&w=2022&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="glass-card p-8 w-full max-w-md relative z-10 fade-in transition-all duration-300">
            <div class="text-center mb-6">
                <div class="w-20 h-20 mx-auto mb-4 relative group">
                    <div class="absolute inset-0 bg-emerald-500/20 rounded-full blur-xl group-hover:bg-emerald-500/30 transition duration-500"></div>
                    <svg viewBox="0 0 100 100" class="w-full h-full relative z-10 drop-shadow-2xl">
                        <defs>
                            <linearGradient id="gradLogo1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#0f172a;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#334155;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M50 5 L88 20 V50 C88 75 50 95 50 95 C50 95 12 75 12 50 V20 L50 5 Z" fill="url(#gradLogo1)" stroke="#10b981" stroke-width="2"/>
                        <path d="M28 45 C28 45 38 52 50 48 C62 52 72 45 72 45 V 72 C72 72 62 78 50 74 C38 78 28 72 28 72 Z" fill="#ffffff"/>
                        <circle cx="50" cy="30" r="6" fill="#fbbf24"/>
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">Cabdullahi Ibnu Mubaarak</h1>
                <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest">Digital Portal</p>
            </div>

            <div class="flex p-1 bg-slate-100 rounded-lg mb-6">
                <button onclick="app.setAuthTab('login')" id="tab-login" class="flex-1 py-2 text-sm font-bold rounded-md bg-white text-emerald-600 shadow-sm transition">Student Login</button>
                <button onclick="app.setAuthTab('register')" id="tab-register" class="flex-1 py-2 text-sm font-bold rounded-md text-slate-500 hover:text-slate-700 transition">Register</button>
            </div>

            <form id="student-login-form" class="space-y-4" onsubmit="app.handleLogin(event, 'student')">
                <div>
                    <input type="text" name="username" placeholder="Username" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition" required>
                </div>
                <div>
                    <input type="password" name="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition" required>
                </div>
                <div id="student-error" class="text-red-500 text-sm hidden flex items-center gap-2"><i data-feather="alert-circle" class="w-4 h-4"></i> Invalid credentials</div>
                <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-emerald-500/30">
                    Login
                </button>
            </form>

            <form id="student-register-form" class="space-y-4 hidden" onsubmit="app.handleRegister(event)">
                <div>
                    <input type="text" name="fullname" placeholder="Full Name" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition" required>
                </div>
                <div>
                    <input type="text" name="username" placeholder="Choose Username" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition" required>
                </div>
                <div>
                    <input type="password" name="password" placeholder="Choose Password" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none transition" required>
                </div>
                <div id="register-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg transition shadow-lg">
                    Create Account
                </button>
            </form>

            <div class="mt-6 pt-4 border-t border-slate-200 text-center">
                <button onclick="app.toggleAdminForm()" class="text-xs text-slate-400 hover:text-emerald-600 transition font-medium">Administration Access</button>
            </div>

            <form id="admin-login-form" class="space-y-4 hidden mt-4 bg-slate-50 p-4 rounded-lg border border-slate-100" onsubmit="app.handleLogin(event, 'admin')">
                <p class="text-xs font-bold text-slate-500 uppercase text-center mb-2">Staff Login</p>
                <div>
                    <input type="text" name="username" placeholder="Admin User" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                </div>
                <div>
                    <input type="password" name="password" placeholder="Password" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none text-sm">
                </div>
                <div id="admin-error" class="text-red-500 text-xs hidden">Access Denied</div>
                <button type="submit" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 rounded-lg text-sm transition">
                    Access Dashboard
                </button>
            </form>
        </div>
    </div>
    
    <!-- TOAST CONTAINER (Non-blocking notifications) -->
    <div id="toast-container" class="fixed top-4 right-4 z-[9999] space-y-2">
        <!-- Toasts go here -->
    </div>

    <div id="student-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="app.closeModal()"></div>
        <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto relative z-10 m-4 fade-in">
            <div id="modal-content" class="p-6">
                <!-- Modal content (Student Profile, Edit Form, or Confirmation) is loaded here -->
                </div>
            <button onclick="app.closeModal()" class="absolute top-4 right-4 p-2 hover:bg-slate-100 rounded-full transition">
                <i data-feather="x" class="w-5 h-5 text-slate-500"></i>
            </button>
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="app.closePostModal()"></div>
        <div class="glass-card w-full max-w-md relative z-10 m-4 fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4">Create Announcement</h2>
                <form onsubmit="app.savePost(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                        <input type="text" name="title" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Content</label>
                        <textarea name="content" rows="4" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Image URL (Optional)</label>
                        <input type="text" name="image" placeholder="https://..." class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <button type="submit" class="w-full bg-emerald-500 text-white py-2 rounded-lg font-bold hover:bg-emerald-600 transition">Publish</button>
                </form>
            </div>
            <button onclick="app.closePostModal()" class="absolute top-4 right-4 p-2 hover:bg-slate-100 rounded-full transition">
                <i data-feather="x" class="w-5 h-5 text-slate-500"></i>
            </button>
        </div>
    </div>

    <div id="app-layout" class="flex h-full hidden relative">
        
        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-slate-900/50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <aside id="sidebar" class="glass-sidebar fixed inset-y-0 left-0 z-30 w-64 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col h-full shadow-xl">
            <div class="p-6 flex items-center gap-3 border-b border-white/10">
                <div class="w-10 h-10 shrink-0 filter drop-shadow-lg">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                        <defs>
                            <linearGradient id="gradSidebar" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M50 5 L85 20 V50 C85 75 50 95 50 95 C50 95 15 75 15 50 V20 L50 5 Z" fill="#ffffff"/>
                        <path d="M50 15 L75 25 V50 C75 70 50 85 50 85 C50 85 25 70 25 50 V25 L50 15 Z" fill="url(#gradSidebar)"/>
                        <path d="M35 48 C35 48 42 52 50 50 C58 52 65 48 65 48 V 68 C65 68 58 72 50 68 C42 72 35 68 35 68 Z" fill="#ffffff"/>
                        <path d="M50 28 L52 34 H58 L53 38 L55 44 L50 40 L45 44 L47 38 L42 34 H48 Z" fill="#fbbf24"/>
                    </svg>
                </div>
                <div class="overflow-hidden">
                    <h1 class="font-bold text-lg leading-tight tracking-wide text-white">Ibnu Mubaarak</h1>
                    <p class="text-[10px] text-emerald-200 uppercase tracking-wider font-semibold">School System</p>
                </div>
            </div>

            <nav class="flex-1 py-6 px-3 space-y-2 overflow-y-auto">
                <a href="#" onclick="app.navigate('dashboard')" class="nav-link flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition group">
                    <i data-feather="grid" class="w-5 h-5 group-hover:scale-110 transition"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="app.navigate('blog')" class="nav-link flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition group">
                    <i data-feather="message-square" class="w-5 h-5 group-hover:scale-110 transition"></i>
                    <span>Announcements</span>
                </a>
                <a href="#" onclick="app.navigate('students')" class="nav-link flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition group">
                    <i data-feather="users" class="w-5 h-5 group-hover:scale-110 transition"></i>
                    <span>Student Management</span>
                </a>
                <a href="#" onclick="app.navigate('attendance')" class="nav-link flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition group">
                    <i data-feather="check-circle" class="w-5 h-5 group-hover:scale-110 transition"></i>
                    <span>Attendance</span>
                </a>
                <a href="#" onclick="app.navigate('fees')" class="nav-link flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition group">
                    <i data-feather="dollar-sign" class="w-5 h-5 group-hover:scale-110 transition"></i>
                    <span>Fees & Finance</span>
                </a>
                <a href="#" onclick="app.navigate('grades')" class="nav-link flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white hover:bg-white/5 rounded-lg transition group">
                    <i data-feather="award" class="w-5 h-5 group-hover:scale-110 transition"></i>
                    <span>Grades & Scores</span>
                </a>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button onclick="app.logout()" class="flex items-center gap-3 px-4 py-3 w-full text-slate-300 hover:text-red-400 hover:bg-white/5 rounded-lg transition">
                    <i data-feather="log-out" class="w-5 h-5"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 w-full">
            <header class="h-16 bg-white/80 backdrop-blur border-b border-slate-200 flex items-center justify-between px-4 md:px-8">
                <div class="flex items-center gap-3">
                    <button onclick="app.toggleSidebar()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        <i data-feather="menu"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="user-info" class="flex items-center gap-3">
                        </div>
                </div>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                </div>
        </main>
    </div>

    <script>
        class Store {
            constructor() {
                this.STORAGE_KEY = 'cim_db_v4'; // Updated key for new data structure
                this.db = this.load();
            }

            load() {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                return stored ? JSON.parse(stored) : this.seed();
            }

            save() {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.db));
            }

            seed() {
                const students = [
                    // Added comprehensive student fields
                    { id: 'ST001', name: 'Abdi Hassan', grade: 'Grade 10', parent: 'Hassan Ali', phone: '252-61-5550101', photo: null, monthlyFee: 50, status: 'Active', enrolled: '2023-01-15' },
                    { id: 'ST002', name: 'Fartun Omar', grade: 'Grade 11', parent: 'Omar Yusuf', phone: '252-61-5550102', photo: null, monthlyFee: 50, status: 'Active', enrolled: '2023-01-20' },
                    { id: 'ST003', name: 'Mohamed Jama', grade: 'Grade 12', parent: 'Jama Farah', phone: '252-61-5550103', photo: null, monthlyFee: 60, status: 'Active', enrolled: '2022-09-01' },
                    { id: 'ST004', name: 'Asha Hussein', grade: 'Grade 10', parent: 'Hussein Ahmed', phone: '252-61-5550104', photo: null, monthlyFee: 50, status: 'Active', enrolled: '2023-02-10' },
                    { id: 'ST005', name: 'Yusuf Adan', grade: 'Grade 9', parent: 'Adan Guled', phone: '252-61-5550105', photo: null, monthlyFee: 40, status: 'Inactive', enrolled: '2023-03-05' },
                ];

                const fees = [];
                const attendance = [];
                const grades = [
                    { studentId: 'ST001', studentName: 'Abdi Hassan', grade: 'Grade 10', subject: 'Math', score: 85, date: '2023-11-01' },
                    { studentId: 'ST001', studentName: 'Abdi Hassan', grade: 'Grade 10', subject: 'Science', score: 78, date: '2023-11-01' },
                    { studentId: 'ST002', studentName: 'Fartun Omar', grade: 'Grade 11', subject: 'Math', score: 92, date: '2023-11-01' },
                ];
                
                const months = ['January', 'February', 'March', 'April', 'May'];
                const statuses = ['Present', 'Absent', 'Late'];
                const today = new Date();

                students.forEach(st => {
                    // Seed fees based on monthlyFee
                    months.forEach((m, idx) => {
                        fees.push({
                            id: `F${st.id}-${idx}`,
                            studentId: st.id,
                            studentName: st.name,
                            month: m,
                            amount: st.monthlyFee || 50, // Use student's fee
                            status: Math.random() > 0.3 ? 'Paid' : 'Unpaid',
                            date: Math.random() > 0.3 ? '2023-01-01' : null
                        });
                    });
                    // Seed attendance
                    for(let i=0; i<7; i++) {
                        const d = new Date();
                        d.setDate(today.getDate() - i);
                        attendance.push({
                            studentId: st.id,
                            date: d.toISOString().split('T')[0],
                            status: statuses[Math.floor(Math.random() * (i === 0 ? 1 : 3))]
                        });
                    }
                });

                const posts = [
                    {
                        id: 'P101',
                        title: 'Welcome to the New Term',
                        body: 'We are delighted to welcome all students back to Cabdullahi Ibnu Mubaarak. Let us work hard and achieve excellence together.',
                        image: 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=1000',
                        date: new Date().toISOString().split('T')[0]
                    }
                ];

                const users = [
                    // Demo student is linked to ST001 for demonstration
                    { fullname: 'Demo Student', username: 'student', password: '123', studentId: 'ST001' } 
                ];

                return { students, fees, attendance, posts, users, grades };
            }

            getStudents() { return this.db.students; }
            getStudent(id) { return this.db.students.find(s => s.id === id); }
            getFees() { return this.db.fees; }
            getAttendance(date = null) { return date ? this.db.attendance.filter(a => a.date === date) : this.db.attendance; }
            getPosts() { return this.db.posts || []; }
            getGrades(studentId = null) { 
                if (!this.db.grades) return [];
                if (studentId) {
                    return this.db.grades.filter(g => g.studentId === studentId);
                }
                return this.db.grades; 
            }
              
            toggleFee(feeId) {
                const fee = this.db.fees.find(f => f.id === feeId);
                if(fee) { 
                    fee.status = fee.status === 'Paid' ? 'Unpaid' : 'Paid'; 
                    this.save(); 
                }
            }
            saveAttendance(records) {
                records.forEach(r => {
                    this.db.attendance = this.db.attendance.filter(a => !(a.studentId === r.studentId && a.date === r.date));
                    this.db.attendance.push(r);
                });
                this.save();
            }
            addStudent(student) {  
                // Note: The structure of student from saveStudentDetails already matches the db structure
                this.db.students.push(student);  
                this.save();  
            }
            updateStudent(id, data) {
                const s = this.getStudent(id);
                if(s) {
                    Object.assign(s, data);
                    this.save();
                    return true;
                }
                return false;
            }
            deleteStudent(id) {
                this.db.students = this.db.students.filter(s => s.id !== id);
                this.db.fees = this.db.fees.filter(f => f.studentId !== id);
                this.db.attendance = this.db.attendance.filter(a => a.studentId !== id);
                this.db.grades = this.db.grades.filter(g => g.studentId !== id);
                this.save();
            }
            addPost(post) {
                if(!this.db.posts) this.db.posts = [];
                this.db.posts.unshift(post);
                this.save();
            }
            registerStudent(user) {
                if(this.db.users.find(u => u.username === user.username)) return { success: false, message: 'Username taken' };
                // In a real app, this would link to a newly created student record.
                user.studentId = 'ST' + Date.now().toString().slice(-4); 
                this.db.users.push(user);
                this.save();
                return { success: true };
            }
            loginStudent(username, password) {
                return this.db.users.find(u => u.username === username && u.password === password);
            }
            saveGrade(gradeRecord) {
                if(!this.db.grades) this.db.grades = [];
                
                const student = this.getStudent(gradeRecord.studentId);
                if (!student) return false;

                // Ensure the grade includes the necessary student info for filtering/display
                gradeRecord.studentName = student.name;
                gradeRecord.grade = student.grade; 

                this.db.grades.unshift(gradeRecord);
                this.save();
                return true;
            }
            getStats() {
                const totalStudents = this.db.students.length;
                const totalRevenue = this.db.fees.filter(f => f.status === 'Paid').reduce((acc, curr) => acc + curr.amount, 0);
                const todayStr = new Date().toISOString().split('T')[0];
                const todayAtt = this.db.attendance.filter(a => a.date === todayStr);
                const presentCount = todayAtt.filter(a => a.status === 'Present').length;
                const attendanceRate = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
                return { totalStudents, totalRevenue, attendanceRate, todayAtt };
            }
        }
        const store = new Store();

        class App {
            constructor() {
                this.currentChart = null;
                this.currentPie = null;
                this.filters = { students: 'All Grades', attendance: 'All Grades', fees: 'All Grades', grades: 'All Grades' };
                this.init();
            }

            init() {
                const role = sessionStorage.getItem('cim_role');
                this.studentUser = sessionStorage.getItem('cim_student_user_id'); // Student's linked ID
                if(role) {
                    this.showApp(role);
                } else {
                    this.showLogin();
                }
            }

            showLogin() {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('app-layout').classList.add('hidden');
                this.setAuthTab('login');
            }

            showApp(role) {
                document.getElementById('login-view').classList.add('hidden');
                const layout = document.getElementById('app-layout');
                layout.classList.remove('hidden');
                const sidebar = document.getElementById('sidebar');

                if(role === 'student') {
                    // Hide Sidebar and Admin links for Students
                    sidebar.classList.add('hidden');
                    document.querySelector('button[onclick="app.toggleSidebar()"]').classList.add('hidden'); 
                    
                    // Update User Info
                    const studentData = store.getStudent(this.studentUser);
                    document.getElementById('user-info').innerHTML = `
                        <div class="text-right">
                            <p class="text-sm font-semibold text-slate-800">${studentData ? studentData.name : 'Student'}</p>
                            <p class="text-xs text-slate-500">Student Portal</p>
                        </div>
                        <button onclick="app.logout()" class="px-3 py-1 bg-slate-200 hover:bg-slate-300 rounded text-xs font-bold transition">Logout</button>
                    `;
                    // Student only sees the dedicated student dashboard view
                    this.navigate('student-dashboard'); 
                } else {
                    // Admin
                    sidebar.classList.remove('hidden');
                    document.querySelector('button[onclick="app.toggleSidebar()"]').classList.remove('hidden');
                    document.getElementById('user-info').innerHTML = `
                        <div class="text-right hidden md:block">
                            <p class="text-sm font-semibold text-slate-800">Maamule</p>
                            <p class="text-xs text-slate-500">Administrator</p>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center border border-emerald-200">
                            <span class="font-bold text-emerald-600">M</span>
                        </div>
                    `;
                    this.navigate('dashboard');
                }
            }

            logout() {
                sessionStorage.removeItem('cim_role');
                sessionStorage.removeItem('cim_student_user_id');
                location.reload();
            }

            // Centralized Toast Notification
            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const id = 'toast-' + Date.now();
                
                const iconMap = {
                    success: { icon: 'check-circle', color: 'bg-emerald-500' },
                    error: { icon: 'x-circle', color: 'bg-red-500' },
                    info: { icon: 'info', color: 'bg-blue-500' }
                };
                const { icon, color } = iconMap[type] || iconMap.info;

                const toast = document.createElement('div');
                toast.id = id;
                toast.className = `flex items-center gap-3 p-4 rounded-lg shadow-xl text-white ${color} transition-all duration-300 transform translate-x-full opacity-0`;
                toast.innerHTML = `<i data-feather="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
                
                container.appendChild(toast);
                feather.replace(); // Initialize icon

                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                    toast.classList.add('translate-x-0', 'opacity-100');
                }, 10);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.remove('translate-x-0', 'opacity-100');
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            // Centralized custom confirm modal (re-uses student-modal structure)
            customConfirm(message, onConfirm) {
                const modal = document.getElementById('student-modal');
                const content = document.getElementById('modal-content');

                const html = `
                    <div class="text-center p-4">
                        <i data-feather="alert-triangle" class="w-10 h-10 text-red-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-bold mb-3 text-slate-800">Confirmation Required</h3>
                        <p class="mb-6 text-slate-600">${message}</p>
                        <div class="flex justify-center gap-4">
                            <button onclick="app.closeModal()" class="px-6 py-2 border rounded-lg text-slate-700 hover:bg-slate-100 transition">Cancel</button>
                            <button id="confirm-action-btn" class="bg-red-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-600 transition">Confirm</button>
                        </div>
                    </div>
                `;
                content.innerHTML = html;
                modal.classList.remove('hidden');
                feather.replace();

                document.getElementById('confirm-action-btn').onclick = () => {
                    onConfirm();
                    this.closeModal();
                };
            }

            setAuthTab(tab) {
                const btnLogin = document.getElementById('tab-login');
                const btnRegister = document.getElementById('tab-register');
                const formLogin = document.getElementById('student-login-form');
                const formRegister = document.getElementById('student-register-form');

                if(tab === 'login') {
                    btnLogin.classList.add('bg-white', 'text-emerald-600', 'shadow-sm');
                    btnLogin.classList.remove('text-slate-500');
                    btnRegister.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm');
                    btnRegister.classList.add('text-slate-500');
                    formLogin.classList.remove('hidden');
                    formRegister.classList.add('hidden');
                    document.getElementById('student-error').classList.add('hidden'); // Clear error
                } else {
                    btnRegister.classList.add('bg-white', 'text-emerald-600', 'shadow-sm');
                    btnRegister.classList.remove('text-slate-500');
                    btnLogin.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm');
                    btnLogin.classList.add('text-slate-500');
                    formRegister.classList.remove('hidden');
                    formLogin.classList.add('hidden');
                    document.getElementById('register-error').classList.add('hidden'); // Clear error
                }
            }

            toggleAdminForm() {
                const form = document.getElementById('admin-login-form');
                form.classList.toggle('hidden');
            }
            
            handleLogin(e, type) {
                e.preventDefault();
                const form = new FormData(e.target);
                const u = form.get('username');
                const p = form.get('password');

                if(type === 'admin') {
                    if(u === 'admin' && p === '123') {
                        sessionStorage.setItem('cim_role', 'admin');
                        document.getElementById('admin-error').classList.add('hidden');
                        this.showApp('admin');
                    } else {
                        document.getElementById('admin-error').classList.remove('hidden');
                    }
                } else {
                    const user = store.loginStudent(u, p);
                    if(user && user.studentId) { // Must be linked to a student record
                        sessionStorage.setItem('cim_role', 'student');
                        sessionStorage.setItem('cim_student_user_id', user.studentId);
                        document.getElementById('student-error').classList.add('hidden');
                        this.studentUser = user.studentId;
                        this.showApp('student');
                    } else {
                        document.getElementById('student-error').classList.remove('hidden');
                    }
                }
            }

            handleRegister(e) {
                e.preventDefault();
                const form = new FormData(e.target);
                const user = {
                    fullname: form.get('fullname'),
                    username: form.get('username'),
                    password: form.get('password')
                };
                  
                const res = store.registerStudent(user);
                if(res.success) {
                    this.showToast('Account created! Please login.', 'success');
                    this.setAuthTab('login');
                } else {
                    const err = document.getElementById('register-error');
                    err.textContent = res.message;
                    err.classList.remove('hidden');
                }
            }
            // ... toggleSidebar is unchanged ...

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if(sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }


            navigate(view) {
                const role = sessionStorage.getItem('cim_role');
                if(role === 'student' && view !== 'student-dashboard' && view !== 'blog') {
                    // Students are restricted to their dashboard (which includes blog/announcements)
                    view = 'student-dashboard'; 
                }

                // Update UI and close sidebar
                if(role === 'admin') {
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active', 'bg-white/10', 'border-l-4', 'border-emerald-500'));
                    const activeLink = document.querySelector(`.nav-link[onclick="app.navigate('${view}')"]`);
                    if(activeLink) activeLink.classList.add('active');
                }
                
                const sidebar = document.getElementById('sidebar');
                if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    document.getElementById('sidebar-overlay').classList.add('hidden');
                }

                const titleMap = { 
                    dashboard: 'Admin Dashboard', 
                    students: 'Student Management', 
                    attendance: 'Attendance', 
                    fees: 'Fees & Finance', 
                    blog: 'Announcements',
                    grades: 'Grades & Scores',
                    'student-dashboard': 'Student Portal'
                };
                document.getElementById('page-title').innerText = titleMap[view];

                const container = document.getElementById('content-area');
                container.innerHTML = '';
                  
                if(this.currentChart) { this.currentChart.destroy(); this.currentChart = null; }
                if(this.currentPie) { this.currentPie.destroy(); this.currentPie = null; }

                switch(view) {
                    case 'student-dashboard': this.renderStudentDashboard(container); break; // New Student View
                    case 'dashboard': this.renderDashboard(container); break;
                    case 'students': this.renderStudents(container); break;
                    case 'attendance': this.renderAttendance(container); break;
                    case 'fees': this.renderFees(container); break;
                    case 'blog': this.renderBlog(container, role); break;
                    case 'grades': this.renderGrades(container); break; // New Admin Grades View
                }
                feather.replace();
            }

            /* --- NEW STUDENT DASHBOARD VIEW --- */
            renderStudentDashboard(container) {
                const studentId = this.studentUser;
                const student = store.getStudent(studentId);
                const studentGrades = store.getGrades(studentId).sort((a, b) => new Date(b.date) - new Date(a.date));
                const posts = store.getPosts();

                const gradesHTML = `
                    <div class="glass-card p-6 mb-8">
                        <h3 class="text-xl font-bold mb-4 text-emerald-600">My Latest Scores</h3>
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${studentGrades.length ? studentGrades.map(g => `
                                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <p class="font-medium">${g.subject} (${g.grade})</p>
                                        <p class="text-xs text-slate-500">${g.date}</p>
                                    </div>
                                    <span class="text-xl font-bold ${g.score >= 75 ? 'text-emerald-600' : 'text-red-500'}">${g.score}%</span>
                                </div>
                            `).join('') : '<p class="text-slate-500">No grades posted yet.</p>'}
                        </div>
                    </div>
                `;

                const announcementList = posts.map(p => `
                    <div class="glass-card overflow-hidden group">  
                        ${p.image ? `<div class="h-48 overflow-hidden"><img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" onerror="this.onerror=null;this.src='https://placehold.co/400x200/e2e8f0/1e293b?text=Image+Unavailable';"></div>` : ''}  
                        <div class="p-6">  
                            <div class="flex items-center gap-2 text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">  
                                <i data-feather="calendar" class="w-3 h-3"></i> ${p.date}  
                            </div>  
                            <h3 class="text-xl font-bold text-slate-800 mb-3">${p.title}</h3>  
                            <p class="text-slate-600 leading-relaxed">${p.body}</p>  
                        </div>  
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="fade-in max-w-3xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-slate-800">Welcome, ${student ? student.name : 'Student'}!</h2>
                        ${gradesHTML}
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">School Announcements</h2>
                        <div class="space-y-8">
                            ${announcementList.length ? announcementList : '<div class="text-center text-slate-400 py-10">No announcements yet.</div>'}
                        </div>
                    </div>
                `;
                feather.replace();
            }

            /* --- ADMIN GRADES VIEW --- */
            renderGrades(container) {
                const grades = ['All Grades', ...Array.from({length:12},(_,i)=>`Grade ${i+1}`)];
                
                container.innerHTML = `
                    <div class="fade-in max-w-5xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Grade & Score Management</h2>
                            <select id="grade-filter" class="p-2 border rounded" onchange="app.renderGrades(document.getElementById('content-area'))">
                                ${grades.map(g=>`<option ${this.filters.grades===g?'selected':''}>${g}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="glass-card p-6 lg:col-span-1">
                                <h3 class="text-xl font-bold mb-4 text-emerald-600">Enter New Score</h3>
                                <form onsubmit="app.postNewGrade(event)" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Select Student</label>
                                        <select name="studentId" class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none" required>
                                            <option value="">-- Choose Student --</option>
                                            ${store.getStudents().map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Subject</label>
                                        <input type="text" name="subject" placeholder="e.g., Physics, Arabic..." class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Score (0-100)</label>
                                        <input type="number" name="score" min="0" max="100" class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" class="w-full px-4 py-2 rounded-lg border border-slate-300 outline-none" required>
                                    </div>
                                    <button type="submit" class="w-full bg-emerald-500 text-white py-2 rounded-lg font-bold hover:bg-emerald-600 transition">Post Score</button>
                                </form>
                            </div>

                            <div class="glass-card p-6 lg:col-span-2">
                                <h3 class="text-xl font-bold mb-4 text-slate-800">Posted Scores</h3>
                                <div class="overflow-y-auto max-h-[500px]">
                                    <table class="w-full text-left">
                                        <thead><tr class="border-b text-slate-500 text-sm"><th class="p-3">Student</th><th class="p-3">Grade</th><th class="p-3">Subject</th><th class="p-3">Score</th><th class="p-3">Date</th></tr></thead>
                                        <tbody id="grade-list">
                                            ${this.renderGradeRows()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                feather.replace();
            }

            renderGradeRows() {
                const filterGrade = document.getElementById('grade-filter')?.value || this.filters.grades;
                this.filters.grades = filterGrade; // Update filter state

                let grades = store.getGrades().sort((a, b) => new Date(b.date) - new Date(a.date));
                if (filterGrade !== 'All Grades') {
                    grades = grades.filter(g => g.grade === filterGrade);
                }

                if (grades.length === 0) return '<tr><td colspan="5" class="p-4 text-center">No grades posted yet for this group.</td></tr>';

                return grades.map(g => `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-3">${g.studentName}</td>
                        <td class="p-3"><span class="bg-slate-200 px-2 py-1 rounded text-xs font-bold">${g.grade}</span></td>
                        <td class="p-3 font-medium">${g.subject}</td>
                        <td class="p-3 text-lg font-bold ${g.score >= 75 ? 'text-emerald-600' : 'text-red-500'}">${g.score}%</td>
                        <td class="p-3 text-sm text-slate-500">${g.date}</td>
                    </tr>
                `).join('');
            }

            postNewGrade(e) {
                e.preventDefault();
                const form = new FormData(e.target);
                const score = parseInt(form.get('score'));

                if (score < 0 || score > 100) {
                    this.showToast('Error: Score must be between 0 and 100.', 'error');
                    return;
                }

                const gradeRecord = {
                    studentId: form.get('studentId'),
                    subject: form.get('subject'),
                    score: score,
                    date: form.get('date')
                };

                if (store.saveGrade(gradeRecord)) {
                    this.showToast('Score posted successfully!', 'success');
                    e.target.reset();
                    // Re-render the page to show the new score
                    this.renderGrades(document.getElementById('content-area'));
                } else {
                    this.showToast('Error: Could not post score. Check if the student ID is valid.', 'error');
                }
            }


            // ... renderBlog is unchanged ...
            renderBlog(container, role) {
                const posts = store.getPosts();
                if (role === 'student') return this.navigate('student-dashboard'); // Redirect student to their primary view
                  
                const adminControls = role === 'admin' ? `  
                    <div class="mb-6 flex justify-end">  
                        <button onclick="app.openPostModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-500/30">  
                            <i data-feather="plus-circle" class="w-5 h-5"></i> Create Announcement  
                        </button>  
                    </div>  
                ` : '';  

                const html = `  
                    <div class="fade-in max-w-3xl mx-auto">  
                        ${adminControls}  
                        <div class="space-y-8">  
                            ${posts.length ? posts.map(p => `  
                                <div class="glass-card overflow-hidden group">  
                                    ${p.image ? `<div class="h-48 overflow-hidden"><img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" onerror="this.onerror=null;this.src='https://placehold.co/400x200/e2e8f0/1e293b?text=Image+Unavailable';"></div>` : ''}  
                                    <div class="p-6">  
                                        <div class="flex items-center gap-2 text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">  
                                            <i data-feather="calendar" class="w-3 h-3"></i> ${p.date}  
                                        </div>  
                                        <h3 class="text-xl font-bold text-slate-800 mb-3">${p.title}</h3>  
                                        <p class="text-slate-600 leading-relaxed">${p.body}</p>  
                                    </div>  
                                </div>  
                            `).join('') : '<div class="text-center text-slate-400 py-10">No announcements yet.</div>'}  
                        </div>  
                    </div>  
                `;  
                container.innerHTML = html;
                feather.replace();
            }  

            openPostModal() { document.getElementById('post-modal').classList.remove('hidden'); }  
            closePostModal() { document.getElementById('post-modal').classList.add('hidden'); }  
              
            savePost(e) {  
                e.preventDefault();  
                const form = new FormData(e.target);  
                store.addPost({  
                    id: 'P'+Date.now(),  
                    title: form.get('title') || 'Untitled', // Error handling: default title
                    body: form.get('content') || 'No content.',
                    image: form.get('image'),  
                    date: new Date().toISOString().split('T')[0]  
                });  
                this.closePostModal();  
                this.navigate('blog'); 
                this.showToast('Announcement posted successfully!', 'success');
            }  

            // ... renderDashboard is unchanged (keeping for completeness) ...
            renderDashboard(container) { 
                 const stats = store.getStats();  
                 const html = `  
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">  
                        <div class="glass-card p-6 flex items-center justify-between">  
                            <div><p class="text-sm text-slate-500 mb-1">Total Students</p><h3 class="text-3xl font-bold text-slate-800">${stats.totalStudents}</h3></div>  
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600"><i data-feather="users"></i></div>  
                        </div>  
                        <div class="glass-card p-6 flex items-center justify-between">  
                            <div><p class="text-sm text-slate-500 mb-1">Total Revenue</p><h3 class="text-3xl font-bold text-slate-800">$${stats.totalRevenue}</h3></div>  
                            <div class="p-3 rounded-full bg-emerald-100 text-emerald-600"><i data-feather="dollar-sign"></i></div>  
                        </div>  
                        <div class="glass-card p-6 flex items-center justify-between">  
                            <div><p class="text-sm text-slate-500 mb-1">Attendance Today</p><h3 class="text-3xl font-bold text-slate-800">${stats.attendanceRate}%</h3></div>  
                            <div class="p-3 rounded-full bg-amber-100 text-amber-600"><i data-feather="calendar"></i></div>  
                        </div>  
                    </div>  
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">  
                        <div class="glass-card p-6 lg:col-span-2"><h4 class="font-semibold text-lg mb-4">Revenue Overview</h4><canvas id="revenueChart" height="250"></canvas></div>  
                        <div class="glass-card p-6"><h4 class="font-semibold text-lg mb-4">Today's Status</h4><canvas id="statusChart" height="250"></canvas></div>  
                    </div>`;  
                container.innerHTML = html;  
                // Dummy data for chart creation (real app would fetch aggregated data)
                const ctx1 = document.getElementById('revenueChart').getContext('2d');  
                this.currentChart = new Chart(ctx1, { type: 'line', data: { labels: ['Jan','Feb','Mar','Apr','May'], datasets: [{ label: 'Fees', data: [1200,1900,3000,2500,2000], borderColor: '#10b981', backgroundColor: '#10b9811a', fill: true }] }, options: { responsive: true, maintainAspectRatio: false } });  
                const ctx2 = document.getElementById('statusChart').getContext('2d');  
                const present = stats.todayAtt.filter(a => a.status === 'Present').length;  
                this.currentPie = new Chart(ctx2, { type: 'doughnut', data: { labels: ['Present','Absent','Late'], datasets: [{ data: [present, stats.todayAtt.filter(a => a.status==='Absent').length, stats.todayAtt.filter(a => a.status==='Late').length], backgroundColor: ['#10b981','#ef4444','#f59e0b'], borderWidth:0 }] }, options: { responsive: true, maintainAspectRatio: false } });  
                feather.replace();
            }  

            // ... renderStudents, generateStudentRows, openAddStudentModal, saveNewStudent, previewPhoto, openStudentProfile, editStudent, saveStudent, deleteStudent, closeModal are updated ...
            renderStudents(container) {  
                let students = store.getStudents();  
                const grades = ['All Grades', ...Array.from({length: 12}, (_, i) => `Grade ${i+1}`)];  
                
                // Apply Grade Filter
                if(this.filters.students !== 'All Grades') students = students.filter(s => s.grade === this.filters.students);  
                
                container.innerHTML = `  
                    <div class="glass-card p-6 fade-in">  
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">  
                            <div class="flex gap-4 w-full md:w-auto flex-1">  
                                <div class="relative w-full md:w-64"><input type="text" id="search-student" placeholder="Search by ID or Name" class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 outline-none focus:border-emerald-500"><i data-feather="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i></div>  
                                <div class="relative w-full md:w-48">  
                                    <select id="filter-grade" class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 outline-none focus:border-emerald-500 appearance-none bg-white cursor-pointer">${grades.map(g => `<option value="${g}" ${this.filters.students === g ? 'selected' : ''}>${g}</option>`).join('')}</select>  
                                    <i data-feather="filter" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>  
                                </div>  
                            </div>  
                            <button onclick="app.openAddStudentModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"><i data-feather="plus" class="w-4 h-4"></i> Add New Student</button>  
                        </div>  
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b text-slate-500 text-sm"><th class="p-3">ID</th><th class="p-3">Photo</th><th class="p-3">Name</th><th class="p-3">Grade</th><th class="p-3">Parent</th><th class="p-3">Status</th><th class="p-3"></th></tr></thead><tbody id="student-table-body">${this.generateStudentRows(students)}</tbody></table></div>  
                    </div>`;  
                document.getElementById('search-student').addEventListener('input', (e) => {  
                    const q = e.target.value.toLowerCase();  
                    const g = this.filters.students;  
                    const filtered = store.getStudents().filter(s => (s.name.toLowerCase().includes(q) || s.id.toLowerCase().includes(q)) && (g === 'All Grades' || s.grade === g));  
                    document.getElementById('student-table-body').innerHTML = this.generateStudentRows(filtered);  
                    feather.replace();  
                });  
                document.getElementById('filter-grade').addEventListener('change', (e) => { this.filters.students = e.target.value; document.getElementById('search-student').dispatchEvent(new Event('input')); });  
                feather.replace();
            }  
            generateStudentRows(students) {  
                if(students.length === 0) return '<tr><td colspan="7" class="p-4 text-center">No students found.</td></tr>';  
                return students.map(s => `  
                    <tr onclick="app.openStudentProfile('${s.id}')" class="border-b hover:bg-slate-50 cursor-pointer group/row">  
                        <td class="p-3">#${s.id}</td>  
                        <td class="p-3"><img src="${s.photo || 'https://ui-avatars.com/api/?name='+s.name}" class="w-8 h-8 rounded-full object-cover"></td>  
                        <td class="p-3 font-medium">${s.name}</td>  
                        <td class="p-3"><span class="bg-slate-200 px-2 py-1 rounded text-xs font-bold">${s.grade}</span></td>  
                        <td class="p-3 text-sm">${s.parent}</td>  
                        <td class="p-3"><span class="px-2 py-0.5 rounded-full text-xs font-bold ${s.status === 'Active' ? 'bg-emerald-100 text-emerald-800' : 'bg-red-100 text-red-800'}">${s.status}</span></td>  
                        <td class="p-3"><button onclick="event.stopPropagation(); app.deleteStudent('${s.id}')" class="text-slate-400 hover:text-red-500 opacity-0 group-hover/row:opacity-100"><i data-feather="trash-2" class="w-4 h-4"></i></button></td>  
                    </tr>`).join('');  
            }  

            openAddStudentModal(studentData = null) {
                const s = studentData || {};
                const isEdit = !!studentData;
                const grades = Array.from({length: 12}, (_, i) => `Grade ${i+1}`);

                const html = `  
                    <h2 class="text-2xl font-bold mb-4">${isEdit ? 'Edit Student Profile' : 'Add New Student'}</h2>  
                    <form onsubmit="app.saveStudentDetails(event, '${s.id || 'new'}')" class="space-y-4">  
                        <div class="text-center">  
                            <div class="w-24 h-24 mx-auto bg-slate-100 rounded-full mb-2 overflow-hidden cursor-pointer border-2 border-slate-200 hover:border-emerald-500 transition" onclick="document.getElementById('p-in').click()">  
                                <img id="p-prev" src="${s.photo || 'https://ui-avatars.com/api/?name=' + (s.name || 'N')}" class="w-full h-full object-cover">  
                            </div>  
                            <input type="file" id="p-in" name="photo" class="hidden" accept="image/*" onchange="app.previewPhoto(this)">  
                            <p class="text-xs text-blue-500 cursor-pointer" onclick="document.getElementById('p-in').click()">Upload/Change Photo</p>  
                        </div>  

                        <input name="name" placeholder="Full Name" value="${s.name || ''}" class="w-full p-2 border rounded" required>
                        
                        <select name="grade" class="w-full p-2 border rounded" required>
                            <option value="">-- Select Grade --</option>
                            ${grades.map(g => `<option value="${g}" ${s.grade === g ? 'selected' : ''}>${g}</option>`).join('')}
                        </select>
                        
                        <input name="parent" placeholder="Parent/Guardian Name" value="${s.parent || ''}" class="w-full p-2 border rounded" required>
                        <input name="phone" type="tel" placeholder="Parent Phone Number" value="${s.phone || ''}" class="w-full p-2 border rounded" required>
                        
                        <label class="block text-sm font-medium text-slate-700">Monthly Fee ($)</label>
                        <input type="number" name="monthlyFee" placeholder="Monthly Fee Amount" value="${s.monthlyFee || 50}" class="w-full p-2 border rounded" required min="0">  

                        <select name="status" class="w-full p-2 border rounded" required>  
                            <option value="Active" ${s.status === 'Active' ? 'selected' : ''}>Active</option>  
                            <option value="Inactive" ${s.status === 'Inactive' ? 'selected' : ''}>Inactive</option>  
                        </select>  

                        <div class="flex justify-end gap-2 pt-4">  
                            <button type="button" onclick="app.closeModal()" class="px-4 py-2 border rounded-lg text-slate-700">Cancel</button>  
                            <button type="submit" class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-emerald-600">${isEdit ? 'Save Changes' : 'Add Student'}</button>  
                        </div>  
                    </form>`;  
                document.getElementById('modal-content').innerHTML = html;  
                document.getElementById('student-modal').classList.remove('hidden');
                feather.replace();
            }
            
            previewPhoto(i) { 
                if(i.files[0]) { 
                    const r = new FileReader(); 
                    r.onload=e=>document.getElementById('p-prev').src=e.target.result; 
                    r.readAsDataURL(i.files[0]); 
                } 
            } 
            
            saveStudentDetails(e, id) {  
                e.preventDefault();  
                const f = new FormData(e.target);  
                const fileInput = document.getElementById('p-in');  
                const currentStudent = id !== 'new' ? store.getStudent(id) : {};
            
                const save = (photoBase64) => {  
                    const data = {  
                        name: f.get('name'),
                        grade: f.get('grade'),
                        parent: f.get('parent'),
                        phone: f.get('phone'), 
                        monthlyFee: parseFloat(f.get('monthlyFee')), 
                        status: f.get('status'),
                        photo: photoBase64 || currentStudent.photo || null // Keep existing photo if new one isn't uploaded
                    };  

                    if (id === 'new') {
                        // Logic for New Student
                        const newStudent = { ...data, id: 'ST' + Date.now().toString().slice(-4), enrolled: new Date().toISOString().split('T')[0] };
                        store.addStudent(newStudent);
                        this.showToast(`New student ${newStudent.name} added with ID #${newStudent.id}`, 'success');
                    } else {
                        // Logic for Editing Student
                        store.updateStudent(id, data);
                        this.showToast(`Student #${id} updated successfully.`, 'success');
                    }

                    this.closeModal();  
                    this.navigate('students');  
                };  
            
                if (fileInput.files && fileInput.files[0]) {  
                    const reader = new FileReader();  
                    reader.onload = (ev) => save(ev.target.result);  
                    reader.readAsDataURL(fileInput.files[0]);  
                } else {  
                    save(null); // Save without photo update
                }
            }

            openStudentProfile(id) { 
                const s = store.getStudent(id); 
                if(!s) { this.showToast('Student not found.', 'error'); return; } 
                
                const att = store.db.attendance.filter(a=>a.studentId===id);  
                const rate = att.length ? Math.round((att.filter(a=>a.status==='Present').length/att.length)*100) : 0;  
                
                let cal = '<div class="grid grid-cols-10 gap-1">';  
                for(let i=29;i>=0;i--) { const d=new Date(); d.setDate(new Date().getDate()-i); const ds=d.toISOString().split('T')[0]; const r=att.find(a=>a.date===ds); cal+=`<div class="h-6 rounded ${r? (r.status==='Present'?'bg-emerald-500':r.status==='Absent'?'bg-red-500':'bg-amber-500'):'bg-slate-200'}" title="${ds} - ${r ? r.status : 'N/A'}"></div>`; }  
                cal+='</div>';  
                
                const html=`  
                    <div class="flex items-center gap-4 mb-4"><img src="${s.photo||'https://ui-avatars.com/api/?name='+s.name}" class="w-16 h-16 rounded-full border-2 border-emerald-500"><div><h2 class="text-xl font-bold">${s.name} (#${s.id})</h2><p class="text-slate-500">${s.grade}</p></div></div>  
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-slate-50 p-3 rounded">
                            <p class="text-sm font-semibold">Parent: ${s.parent}</p>
                            <p class="text-sm font-semibold">Phone: ${s.phone}</p>
                            <p class="text-sm font-semibold">Monthly Fee: $${s.monthlyFee}</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded text-center">
                            <span class="text-3xl font-bold ${rate>=75?'text-emerald-500':'text-red-500'}">${rate}%</span><br>
                            <p class="text-sm text-slate-500">Attendance Rate (30 Days)</p>
                        </div>
                    </div>  
                    <div class="mb-4"><p class="text-xs font-bold uppercase mb-2">Attendance History (30 Days)</p>${cal}</div>  
                    <div class="flex justify-between">
                        <button onclick="app.deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700 transition">Delete Student</button>
                        <div class="flex gap-2">
                            <button type="button" onclick="app.closeModal()" class="px-3 py-1 border rounded-lg text-slate-700">Close</button>
                            <button onclick="app.editStudent('${s.id}')" class="bg-emerald-500 text-white px-3 py-1 rounded-lg hover:bg-emerald-600 transition">Edit Details</button>
                        </div>
                    </div>  
                `;  
                document.getElementById('modal-content').innerHTML=html; 
                document.getElementById('student-modal').classList.remove('hidden');
                feather.replace();
            }  
            
            editStudent(id) { 
                const s = store.getStudent(id); 
                this.openAddStudentModal(s); // Reuse the add modal for editing
            }  
            
            deleteStudent(id) { 
                // Changed: Replaced confirm() with customConfirm()
                this.customConfirm(`Are you sure you want to permanently delete student #${id} and all associated records (fees, attendance, grades)?`, () => {
                    store.deleteStudent(id); 
                    this.closeModal(); 
                    this.navigate('students'); 
                    this.showToast(`Student #${id} deleted successfully.`, 'error');
                });
            }  
            
            closeModal() { document.getElementById('student-modal').classList.add('hidden'); }  
              
            // ... renderAttendance and saveDailyAttendance are updated to use grade filter ...
            renderAttendance(container) { 
                const grades = ['All Grades', ...Array.from({length:12},(_,i)=>`Grade ${i+1}`)];  
                container.innerHTML=`<div class="fade-in"><div class="flex justify-between mb-4"><h2 class="text-xl font-bold">Daily Attendance Recording</h2><select id="att-grade" class="p-2 border rounded">${grades.map(g=>`<option ${this.filters.attendance===g?'selected':''}>${g}</option>`).join('')}</select></div><div id="att-list"></div></div>`;  
                
                const render=()=>{  
                    const g=document.getElementById('att-grade').value; 
                    this.filters.attendance = g; // Update filter state
                    const all=store.getStudents(); 
                    const list=g==='All Grades'?all:all.filter(s=>s.grade===g);  
                    
                    if(!list.length) { document.getElementById('att-list').innerHTML='<p class="p-4 text-center glass-card">No students found in this grade.</p>'; return; } 
                    
                    const today=new Date().toISOString().split('T')[0];  
                    document.getElementById('att-list').innerHTML=`
                        <div class="glass-card p-4">
                            <h3 class="font-bold mb-2">Attendance for: ${g} (${today})</h3>
                            <div class="max-h-96 overflow-y-auto">
                                <table class="w-full">  
                                ${list.map(s=>{ 
                                    const st=store.getAttendance(today).find(a=>a.studentId===s.id)?.status||'Present'; 
                                    return `<tr>
                                        <td class="p-2">${s.name} <span class="text-xs text-slate-400">#${s.id}</span></td>
                                        <td>  
                                            <div class="flex gap-4">
                                                <label><input type="radio" name="att_${s.id}" value="Present" ${st==='Present'?'checked':''}> Present</label>
                                                <label><input type="radio" name="att_${s.id}" value="Absent" ${st==='Absent'?'checked':''}> Absent</label>
                                                <label><input type="radio" name="att_${s.id}" value="Late" ${st==='Late'?'checked':''}> Late</label>
                                            </div>
                                        </td>
                                    </tr>`; 
                                }).join('')}  
                                </table>
                            </div>
                            <button onclick="app.saveDailyAttendance()" class="mt-4 bg-emerald-500 text-white px-4 py-2 rounded w-full font-bold hover:bg-emerald-600 transition">Save Attendance</button>
                        </div>`;  
                };  
                document.getElementById('att-grade').addEventListener('change',render);  
                render();  
            }  
            
            saveDailyAttendance() {  
                const g=this.filters.attendance; 
                const all=store.getStudents(); 
                const list=g==='All Grades'?all:all.filter(s=>s.grade===g);  
                const recs=[]; 
                const today=new Date().toISOString().split('T')[0];  
                
                list.forEach(s=>{ 
                    const radio=document.querySelector(`input[name="att_${s.id}"]:checked`);
                    if(radio) {
                        recs.push({studentId:s.id, date:today, status:radio.value});
                    }
                });  
                
                if (recs.length > 0) {
                    store.saveAttendance(recs); 
                    this.showToast('Attendance records saved successfully!', 'success');
                } else {
                    this.showToast('No attendance data selected to save.', 'info');
                }
            }  

            // ... renderFees and toggleFee are updated to use grade filter ...
            renderFees(container) { 
                const grades = ['All Grades', ...Array.from({length:12},(_,i)=>`Grade ${i+1}`)];  
                container.innerHTML=`<div class="fade-in"><div class="flex justify-between mb-4"><h2 class="text-xl font-bold">Fees & Financial Records</h2><select id="fee-grade" class="p-2 border rounded">${grades.map(g=>`<option ${this.filters.fees===g?'selected':''}>${g}</option>`).join('')}</select></div><div class="glass-card overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b text-slate-500 text-sm"><th class="p-3">ID</th><th class="p-3">Student Name</th><th class="p-3">Grade</th><th class="p-3">Month</th><th class="p-3">Amount</th><th class="p-3">Status</th><th class="p-3">Action</th></tr></thead><tbody id="fee-list"></tbody></table></div></div>`;  
                
                const render=()=>{  
                    const g=document.getElementById('fee-grade').value;
                    this.filters.fees = g; // Update filter state
                    const fees=store.getFees().filter(f=>{ 
                        if(g==='All Grades') return true; 
                        const s=store.getStudent(f.studentId); 
                        return s && s.grade===g; 
                    }).sort((a, b) => a.studentName.localeCompare(b.studentName));
                    
                    document.getElementById('fee-list').innerHTML=fees.length ? fees.map(f=>{
                        const student = store.getStudent(f.studentId);
                        const studentGrade = student ? student.grade : 'N/A';

                        return `  
                            <tr class="border-b group hover:bg-slate-50">
                                <td class="p-3 font-mono text-xs">#${f.id.split('-')[0]}</td>
                                <td class="p-3 font-medium">${f.studentName}</td>
                                <td class="p-3"><span class="bg-slate-200 px-2 py-1 rounded text-xs font-bold">${studentGrade}</span></td>
                                <td class="p-3">${f.month}</td>
                                <td class="p-3 font-bold">$${f.amount}</td>  
                                <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${f.status==='Paid'?'bg-emerald-100 text-emerald-700':'bg-red-100 text-red-700'}">${f.status}</span></td>  
                                <td class="p-3"><button onclick="app.toggleFee('${f.id}')" class="border px-2 py-1 rounded text-xs hover:bg-slate-200 transition">Toggle Status</button></td>
                            </tr>  
                        `; 
                    }).join('') : '<tr><td colspan="7" class="p-4 text-center">No fee records found for this grade.</td></tr>';  
                };  
                document.getElementById('fee-grade').addEventListener('change',render);  
                render();  
            }  
            toggleFee(id) { 
                store.toggleFee(id); 
                // Re-render only the list to reflect change without full page navigation
                this.renderFees(document.getElementById('content-area')); 
                this.showToast('Fee status updated.', 'info');
            }  
        }  

        const app = new App();
        
        // Initialize feather icons on load
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
        });
    </script>

</body>  
</html>

